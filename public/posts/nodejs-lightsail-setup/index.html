<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Complete NodeJS App Setup on an AWS Lightsail VPS | limistah</title>
<meta name=keywords content="AWS,MongoDB,NodeJS,Nginx"><meta name=description content="In this post, we will explore how to set up a NodeJS app on Amazon’s Lightsail instance. We will also explore setting up a CircleCI job for a NodeJS project, use Nginx as a web server, setup SSL for the server, and allow a local machine to access the remote server.
Prerequisites AWS Lightsail instance AWS Route53 domain (not mandatory) CircleCI account Github repo for the NodeJS project. Let’s begin!"><meta name=author content="AI"><link rel=canonical href=https://limistah.dev/posts/nodejs-lightsail-setup/><link crossorigin=anonymous href=/assets/css/stylesheet.b609c58d5c11bb90b1a54e04005d74ad1ddf22165eb79f5533967e57df9c3b50.css integrity="sha256-tgnFjVwRu5CxpU4EAF10rR3fIhZet59VM5Z+V9+cO1A=" rel="preload stylesheet" as=style><link rel=icon href=https://limistah.dev/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://limistah.dev/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://limistah.dev/favicon-32x32.png><link rel=apple-touch-icon href=https://limistah.dev/apple-touch-icon.png><link rel=mask-icon href=https://limistah.dev/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><meta property="og:title" content="Complete NodeJS App Setup  on an AWS Lightsail VPS"><meta property="og:description" content="In this post, we will explore how to set up a NodeJS app on Amazon’s Lightsail instance. We will also explore setting up a CircleCI job for a NodeJS project, use Nginx as a web server, setup SSL for the server, and allow a local machine to access the remote server.
Prerequisites AWS Lightsail instance AWS Route53 domain (not mandatory) CircleCI account Github repo for the NodeJS project. Let’s begin!"><meta property="og:type" content="article"><meta property="og:url" content="https://limistah.dev/posts/nodejs-lightsail-setup/"><meta property="og:image" content="https://limistah.dev/images/papermod-cover.png"><meta property="article:section" content="posts"><meta property="article:published_time" content="2019-08-06T00:00:00+00:00"><meta property="article:modified_time" content="2019-08-06T00:00:00+00:00"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://limistah.dev/images/papermod-cover.png"><meta name=twitter:title content="Complete NodeJS App Setup  on an AWS Lightsail VPS"><meta name=twitter:description content="In this post, we will explore how to set up a NodeJS app on Amazon’s Lightsail instance. We will also explore setting up a CircleCI job for a NodeJS project, use Nginx as a web server, setup SSL for the server, and allow a local machine to access the remote server.
Prerequisites AWS Lightsail instance AWS Route53 domain (not mandatory) CircleCI account Github repo for the NodeJS project. Let’s begin!"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://limistah.dev/posts/"},{"@type":"ListItem","position":2,"name":"Complete NodeJS App Setup  on an AWS Lightsail VPS","item":"https://limistah.dev/posts/nodejs-lightsail-setup/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Complete NodeJS App Setup  on an AWS Lightsail VPS","name":"Complete NodeJS App Setup  on an AWS Lightsail VPS","description":"In this post, we will explore how to set up a NodeJS app on Amazon’s Lightsail instance. We will also explore setting up a CircleCI job for a NodeJS project, use Nginx as a web server, setup SSL for the server, and allow a local machine to access the remote server.\nPrerequisites AWS Lightsail instance AWS Route53 domain (not mandatory) CircleCI account Github repo for the NodeJS project. Let’s begin!","keywords":["AWS","MongoDB","NodeJS","Nginx"],"articleBody":"In this post, we will explore how to set up a NodeJS app on Amazon’s Lightsail instance. We will also explore setting up a CircleCI job for a NodeJS project, use Nginx as a web server, setup SSL for the server, and allow a local machine to access the remote server.\nPrerequisites AWS Lightsail instance AWS Route53 domain (not mandatory) CircleCI account Github repo for the NodeJS project. Let’s begin!\nSpinning up an instance I have spun up a $5 instance with my account, it comes with 1 GB RAM, 1 vCPU, 40 GB SSD. Below is the image configuration I used while setting up the instance:\nAWS Lightsail is configured to use a dynamic IP each time the server is restarted, a basic sudo reboot would give the server another IP address, we should configure a static IP for our server. This will save us the dynamic IP rotation.\nAdding static IP to an instance On the instance dashboard that you have created, click on the Network tab, then Attach static IP button.\nIt will toggle a select input to pick from existing static IPs that are not yet attached to an instance or create one. I have created one already so I only selected from the list, then the green button to confirm my selection. If you do not have one, enter a name for the IP then click on create button to create one, after which you can then attach to the instance.\nEither way, we now have a static IP attached to our Lightsail server. Cool isn’t it?\nAllowing SSH access from a local machine AWS Lightsail comes with a web-based terminal that runs like a regular UNIX terminal. I do not feel at home with it, so, I will be setting up an SSH access for the instance. This will improve my productivity working with the VPS.\nFrom the Lightsail home page, choose the instance you are working with, then click on the connect using SSH button.\nA new browser window should pop up, you should see:\nNext, from the command prompt run:\nsudo nano ~/.ssh/authorized_keys You should be greeted with a page containing default ssh key for your instance(more on this later). We will be adding our local machine’s public ssh key below the key already in the authorized_keys file.\nFrom your local machine, create an ssh key or use an existing one. I am using an already existing one, the command below will copy my id_rsa.pub file to my clipboard.\nxclip -sel clip \u003c ~/.ssh/id_rsa.pub Back in the web terminal, from the interface, there is a clipboard icon, click on it a text area should appear at the top of the icon. Click into the text box, then press Ctrl+V or Cmd+V to paste the contents from your local clipboard into the browser-based SSH client clipboard. Right-click any area on the SSH terminal screen to paste the text from the browser-based SSH client clipboard to the terminal screen. Easy, right?\nTo exit the edit window, press Ctrl+X, press Y to confirm the modification, and ENTER to complete the process.\nFinally, reboot the server to reflect our changes:\nsudo reboot From our local machine’s terminal, we can run:\nssh ubuntu@LIGHT_SAIL_STATIC_IP Replace LIGHT_SATIL_STATIC_IP with the static IP attached to your instance. If all goes well, you should be welcomed with the same message as the web terminal does. Well done!!!\nFinally, for our AWS setup, we can go further to mask our static IP to a domain name. AWS Route53 can do that for us easily, I won’t be covering that here, you can look up this article for the process.\nInstalling NodeJS To run our NodeJS code on the server, we need to install NodeJS runtime. I followed a tutorial from Tecadmin, here are the commands to do the installation:\nsudo apt update sudo apt install -y mongodb sudo systemctl enable mongodb sudo systemctl start mongodb sudo systemctl status mongodb The last command should give a working systemd status with a green highlight:\nAdding a new user account for deployment To deploy your app, you will require a copy of your NodeJS app code on the server. It is a good practice to have a user account whose sole purpose is to serve your app.\nTo create a new user for your Ubuntu server, running the below command will create a new user dkapi it will also create a home directory for the user at /home/dkapi\nsudo useradd -m -d /home/dkapi dkapi Next, you should add a password for the user that you just created, the command below will prompt for a password to be used for dkapi.\nsudo passwd dkapi You should be able to run commands as sudo user with the newly created user account. The below command will allow that to be possible:\nusermod -aG sudo dkapi Now, you can switch to the user you just created with:\nsu - dkapi Provide the password you entered when creating the account, you should find a prompt with a $_ sign, that’s a success. Cool!\nCreating ssh keys for Github access I followed the guide by Github to create an SSH key from here. Then, add the generated ssh to your Github account using the guide from here. Finally, we can test our Github SSH set up with the guide from here.\nPulling the NodeJS codebase from Github We are here, you can now pull your NodeJS code from Github. This is basically cloning the repo, and this can be done easily with:\ngit clone GITHUB_SSH_URL ~/app The repo will be cloned into ~/app directory\nFollow the guide here to install Yarn on the instance, after that you can install the dependencies using yarn command.\nRunning NodeJS app in the background For perfect integration with Nginx, you need to run your NodeJS app in the background. Packages like forever, pm2 gives this process a breeze. But, for me, I think using a systemd service is more appropriate, as I can start, stop and enable autostart of the service whenever the server is restarted. With the SSH access,systemd service has an edge over an npm package.\nA systemd service are instruction files created at: /lib/systemd/system/ and the files are to end with .service extension. Full details about systemd can be found here. Let’s create one for ourselves.\nFirstly, run sudo nano /lib/systemd/system/dkapi.service you can name dkapi.serviceanything, just ensure that it ends with a.service` as the file’s extension.\nThe content of the file should look like:\n[Unit] Description=APP API Service After=network.target StartLimitIntervalSec=0 [Service] Type=simple Restart=always RestartSec=1 User=dkapi ExecStart=/usr/bin/node /home/dkapi/app/start.sh WorkingDirectory=/home/dkapi/app StandardOutput=syslog StandardError=syslog SyslogIdentifier=dk-api Environment= NODE_ENV=production [Install] WantedBy=multi-user.target Attention should be paid to User=dkapi that should be the user account you created for the deployment, ExecStart=/home/dkapi/app/start.sh this is the start command for the service, basically calling an executable start.sh file. The file in my own case contains:\nyarn start Ensure that this file can be executed, use sudo chmod +x start.sh for this.\nThe WorkingDirectory=/home/dkapi/app should be the directory you pulled the files from Github into. And Environment= NODE_ENV=production to tell the environment variable you want the service to have.\nNext, enter Ctrl+X then ENTER to save the file. Now, you have a service systemd that can be used to manage your NodeJS server instance.\nTo enable the server to start when the server boots up we can do: To do systemctl enable dkapi Now, we can manually start our service with:\nsudo systemctl start dkapi\nGreatness!!!\nInstalling Nginx webserver NodeJS app only creates a local server, to accept request over the internet, we need a web server that will make that a breeze. We can do Apache, but I love Nginx for its simplicity, we will be installing and configuring one for this setup.\nFrom your SSH accessed server terminal run the below command to update the installed packages:\nsudo apt update \u0026\u0026 sudo apt upgrade After that, you can install Nginx with:\nsudo apt install nginx A successful installation will give you:\nVisiting the static IP attached to this instance gives the default welcome page for a successful Nginx installation. Awesomeness!!!\nNginx configuration for NodeJs server routing To ensure that requests are passed to your NodeJS app, you need to have the default Nginx configuration block point to your the local URL of the app.\nWe will begin this by configuring our Nginx webserver.\nChanging directory to nginx installation directory with: cd /etc/nginx/ In the sites-available directory, copy the default config file to default.bak using sudo cp default default.bak, then use sudo nano ./sites-available/default to edit the content of the file.\nHere is a configuration that receives a normal request from the client then transfer it to the node server we have set up above.\nserver { server_name SERVER_NAME_OR_STATIC_IP; location = /favicon.ico { log_not_found off; access_log off; } location = /robots.txt { allow all; log_not_found off; access_log off; } location / { proxy_pass http://localhost:3000; proxy_http_version 1.1; proxy_set_header Upgrade $http_upgrade; proxy_set_header Connection 'upgrade'; proxy_set_header Host $host; proxy_set_header X-Real-IP $remote_addr; proxy_cache_bypass $http_upgrade; } access_log /var/log/nginx/dkapi-access.log; error_log /var/log/nginx/dkapi-error.log error; } Change the SERVER_NAME_OR_STATIC_IP to your server name that points to the static IP, or just use the Lightsail server static IP.\nIf all went well, visiting the server name or static IP should yield the default response for our app. Mine:\nAdding free SSL by letsencrypt Sometimes, accessing our NodeJS app using normal unsecured HTTP would throw a warning screen or will not resolve. This is a security feature implemented by web browsers and hosting providers. To this, I always install SSL for nginx servers. We will be doing a setup with let’s encrypt as generally done.\nRun the below command to install certbot package.\napt-get install software-properties-common add-apt-repository ppa:certbot/certbot apt-get update apt-get install python-certbot-nginx To set up an SSL for your domain, you can do:\ncertbot --nginx It will check the CN (common name) in the existing Nginx configuration file, if not found then it will prompt you to enter the domain name.\nCertbot automation is smart! It will take care of all the necessary configurations to make your Nginx ready to serve over https.\nNot so fast, but we now have SSL support for our nginx web server at the specified domain name.\nTo allow HTTPS requests to come through into the VPS instance, you have to modify the firewall from the Network tab on the instance dashboard. Click on Add another, select HTTPS, then click on the green tick.\nIt should look something like this:\nAnd that’s it! Full HTTPS support without an extra.\nTaking things further If you have a build process and a Continous Integration, you should be thinking of setting it up. This would protect against the round trip of pulling and restarting our app on the server.\nI assume that the project has been set up on CircleCI already using a Github account. Let’s move forward.\nf you notice from the bottom page of the Lightsail server instance dashboard Connect tab, it states, “You configured this instance to use id_rsa (key_region) key pair.” This is a secret SSH key and can be managed from https://lightsail.aws.amazon.com/ls/webapp/account/keys.\nThe keys from the page above are private keys whose public keys are included in instance setups. Lucky enough, it has been included in my own setup and it is what CircleCI is requesting to access my server remotely. It is not included in the authorised_keys of the user account that you have created, you are to add the public key in there.\nTo get the content of the file, firstly download the ssh key attached to the instance, next use cat command to show the content of the file. In my own case:\ncat LightsailDefaultKey-us-east-1.pem On the project page in CircleCI dashboard, click the settings icon close to the project, then SSH Permissions. Click on the blue Add SSH Key button enter the domain name for the key, then paste the copy private key into the Private key input, click the light blue Add SSH Key button to complete the process.\nNew user accounts do not come with the private ssh configured, we have to manually add this ourselves. To do this, we can generate a public key from the downloaded private key using:\nssh-keygen -y -f ~/.ssh/lightsail.pem \u003e ~/.ssh/lightsail.pem.pub Then you can copy the content of ~/.ssh/lightsail.pem.pub to the authorized_keys file of the account for your app. Simply:\nsu — dkapi sudo nano ~/.ssh/authorized_keys Paste the copied public key into the file, then Ctrl + X to save.\nBelow is the CircleCI config for my own project, yours might be different. The important part here is the command section.\nversion: 2 jobs: staging: docker: - image: circleci/node:10 steps: - run: name: Deploy API command: ssh -o \"StrictHostKeyChecking no\" api@staging.datingkinky.com \"cd ~/app; git pull; yarn install --production; sudo systemctl restart dkapi\" workflows: version: 2 staging: jobs: - staging: filters: branches: only: develop The emphasis is on this:\nssh -o \"StrictHostKeyChecking no\" dkapi@staging.datingkinky.com \"cd ~/app; git pull; yarn install --production; sudo systemctl restart dkapi\" To note from the above command:\ndkapi@staging.datingkinky.com: We want to connect to the instance but as the dkapi user we created. cd ~/app: Change directory to the app directory we pulled the code into. git pull: Pull the code from Github to keep the code updated yarn install — production: Install dependencies that might have just been included. sudo systemctl restart dkapi: Restarts the dkapi service running the NodeJS app in the background using systemd service A perfect process right?\nPush a new code, let CircleCI do your deployment and restarting the node app for you. Sooo cool!!!\nBeautiful? Not yet!\nGotcha I ran into a failing build, which is a result of the systemctl command. The error states\nno tty present and no askpass program specified Basically, we have to bypass systemctl asking for password whenever we run it from a trusted machine. I found the solution from Stackoverflow.\nNow, we have to ssh as a root user, then run:\nsudo visudo The command will pop a file for editing, it is a delicate file that can mar all the effort we have put into the setup. What we have to do in here is to go to the end of the file to add:\ndkapi ALL = NOPASSWD: /bin/systemctl Replace dkapi with the user you created in for deployment.\nUse Ctrl+X to exit the file. Then, we can rerun the failed CircleCI workflow or push a new code to test the setup.\nIt ran successfully in my own case, I believe yours too would have been successful.\nAwesome!!! Highlights Spinup a Lightsail instance Add a static IP to the instance Allow SSH access from a local machine Installing NodeJS Installing MongoDB Adding a new user account for deployment Creating ssh key for Github access Pulling the NodeJS repo from Github Running NodeJS app in the background Installing Nginx webserver Nginx configuration for NodeJS server routing Adding free SSL by letsencrypt Integrate CircleCI CircleCI integration gotcha Conclusion Following through this post, we have configured a non-existent AWS Lightsail server instance to run a NodeJS app. We have been able to set up the code to run a systemd service for the app to be able to run in the background.\nWe added SSL and then finalized the setup with a CircleCI integration and a fix to a known error that could cause the build process to fail.\nI will like to learn if there is any part that could be improved, know about a bug that stops your own setup and learn more about the AWS Lightsail Servers.\nThank you for reading. I appreciate your patience!!!\n","wordCount":"2596","inLanguage":"en","datePublished":"2019-08-06T00:00:00Z","dateModified":"2019-08-06T00:00:00Z","author":{"@type":"Person","name":"AI"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://limistah.dev/posts/nodejs-lightsail-setup/"},"publisher":{"@type":"Organization","name":"limistah","logo":{"@type":"ImageObject","url":"https://limistah.dev/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://limistah.dev accesskey=h title="limistah (Alt + H)">limistah</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://limistah.dev/blog title=Blog><span>Blog</span></a></li><li><a href=https://limistah.dev/search/ title="Search (Alt + /)" accesskey=/><span>Search</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://limistah.dev>Home</a>&nbsp;»&nbsp;<a href=https://limistah.dev/posts/>Posts</a></div><h1 class="post-title entry-hint-parent">Complete NodeJS App Setup on an AWS Lightsail VPS</h1><div class=post-meta><span title='2019-08-06 00:00:00 +0000 UTC'>August 6, 2019</span>&nbsp;·&nbsp;13 min&nbsp;·&nbsp;AI&nbsp;|&nbsp;<a href=https://github.com/limistah/limistah.xyz/tree/main/content/posts/nodejs-lightsail-setup.md rel="noopener noreferrer" target=_blank>Suggest Changes</a></div></header><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><ul><li><a href=#prerequisites aria-label=Prerequisites>Prerequisites</a></li><li><a href=#spinning-up-an-instance aria-label="Spinning up an instance">Spinning up an instance</a></li><li><a href=#adding-static-ip-to-an-instance aria-label="Adding static IP to an instance">Adding static IP to an instance</a></li><li><a href=#allowing-ssh-access-from-a-local-machine aria-label="Allowing SSH access from a local machine">Allowing SSH access from a local machine</a></li><li><a href=#installing-nodejs aria-label="Installing NodeJS">Installing NodeJS</a></li><li><a href=#adding-a-new-user-account-for-deployment aria-label="Adding a new user account for deployment">Adding a new user account for deployment</a></li><li><a href=#creating-ssh-keys-for-github-access aria-label="Creating ssh keys for Github access">Creating ssh keys for Github access</a></li><li><a href=#pulling-the-nodejs-codebase-from-github aria-label="Pulling the NodeJS codebase from Github">Pulling the NodeJS codebase from Github</a></li><li><a href=#running-nodejs-app-in-the-background aria-label="Running NodeJS app in the background">Running NodeJS app in the background</a></li><li><a href=#installing-nginx-webserver aria-label="Installing Nginx webserver">Installing Nginx webserver</a><ul><li><a href=#nginx-configuration-for-nodejs-server-routing aria-label="Nginx configuration for NodeJs server routing">Nginx configuration for NodeJs server routing</a></li><li><a href=#adding-free-ssl-by-letsencrypt aria-label="Adding free SSL by letsencrypt">Adding free SSL by letsencrypt</a></li></ul></li><li><a href=#taking-things-further aria-label="Taking things further">Taking things further</a></li><li><a href=#gotcha aria-label=Gotcha>Gotcha</a><ul><ul><li><a href=#awesome aria-label=Awesome!!!>Awesome!!!</a></li></ul></ul></li><li><a href=#highlights aria-label=Highlights>Highlights</a></li><li><a href=#conclusion aria-label=Conclusion>Conclusion</a></li></ul></div></details></div><div class=post-content><p>In this post, we will explore how to set up a NodeJS app on Amazon’s Lightsail instance. We will also explore setting up a CircleCI job for a NodeJS project, use Nginx as a web server, setup SSL for the server, and allow a local machine to access the remote server.</p><h2 id=prerequisites>Prerequisites<a hidden class=anchor aria-hidden=true href=#prerequisites>#</a></h2><ul><li><a href=https://lightsail.aws.amazon.com/ls/webapp/home/instances>AWS Lightsail instance</a></li><li><a href=https://console.aws.amazon.com/route53/home>AWS Route53 domain (not mandatory)</a></li><li><a href=https://circleci.com/>CircleCI account</a></li><li>Github repo for the NodeJS project.</li></ul><p>Let’s begin!</p><h2 id=spinning-up-an-instance>Spinning up an instance<a hidden class=anchor aria-hidden=true href=#spinning-up-an-instance>#</a></h2><p>I have spun up a $5 instance with my account, it comes with <strong><em>1 GB RAM, 1 vCPU, 40 GB SSD</em></strong>. Below is the image configuration I used while setting up the instance:</p><p><img loading=lazy src=/assets/lightsail-new.png alt="Lightsail new"></p><p>AWS Lightsail is configured to use a dynamic IP each time the server is restarted, a basic sudo reboot would give the server another IP address, we should configure a static IP for our server. This will save us the dynamic IP rotation.</p><h2 id=adding-static-ip-to-an-instance>Adding static IP to an instance<a hidden class=anchor aria-hidden=true href=#adding-static-ip-to-an-instance>#</a></h2><p>On the instance dashboard that you have created, click on the Network tab, then Attach static IP button.</p><p><img loading=lazy src=/assets/lightsail-ip.png alt="Lightsail IP"></p><p>It will toggle a select input to pick from existing static IPs that are not yet attached to an instance or create one. I have created one already so I only selected from the list, then the green button to confirm my selection. If you do not have one, enter a name for the IP then click on create button to create one, after which you can then attach to the instance.</p><p>Either way, we now have a static IP attached to our Lightsail server. Cool isn’t it?</p><h2 id=allowing-ssh-access-from-a-local-machine>Allowing SSH access from a local machine<a hidden class=anchor aria-hidden=true href=#allowing-ssh-access-from-a-local-machine>#</a></h2><p>AWS Lightsail comes with a web-based terminal that runs like a regular UNIX terminal. I do not feel at home with it, so, I will be setting up an SSH access for the instance. This will improve my productivity working with the VPS.</p><p>From the Lightsail home page, choose the instance you are working with, then click on the connect using SSH button.</p><p><img loading=lazy src=/assets/lightsail-ssh.png alt="Lightsail SSH"></p><p>A new browser window should pop up, you should see:</p><p><img loading=lazy src=/assets/lightsail-terminal.png alt="Lightsail Terminal"></p><p>Next, from the command prompt run:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>sudo nano ~/.ssh/authorized_keys
</span></span></code></pre></div><p>You should be greeted with a page containing default ssh key for your instance(more on this later). We will be adding our local machine’s public ssh key below the key already in the <code>authorized_keys</code> file.</p><p>From your local machine, create an ssh key or use an existing one. I am using an already existing one, the command below will copy my id_rsa.pub file to my clipboard.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>xclip -sel clip &lt; ~/.ssh/id_rsa.pub
</span></span></code></pre></div><p>Back in the web terminal, from the interface, there is a clipboard icon, click on it a text area should appear at the top of the icon. Click into the text box, then press <code>Ctrl+V</code> or <code>Cmd+V</code> to paste the contents from your local clipboard into the browser-based SSH client clipboard. Right-click any area on the SSH terminal screen to paste the text from the browser-based SSH client clipboard to the terminal screen. Easy, right?</p><p>To exit the edit window, press <code>Ctrl+X</code>, press <code>Y</code> to confirm the modification, and <code>ENTER</code> to complete the process.</p><p>Finally, reboot the server to reflect our changes:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>sudo reboot
</span></span></code></pre></div><p>From our local machine’s terminal, we can run:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>ssh ubuntu@LIGHT_SAIL_STATIC_IP
</span></span></code></pre></div><p>Replace <code>LIGHT_SATIL_STATIC_IP</code> with the static IP attached to your instance. If all goes well, you should be welcomed with the same message as the web terminal does. Well done!!!</p><p>Finally, for our AWS setup, we can go further to mask our static IP to a domain name. AWS Route53 can do that for us easily, I won’t be covering that here, you can look up <a href=https://lightsail.aws.amazon.com/ls/docs/en_us/articles/amazon-lightsail-using-route-53-to-point-a-domain-to-an-instance>this article</a> for the process.</p><h2 id=installing-nodejs>Installing NodeJS<a hidden class=anchor aria-hidden=true href=#installing-nodejs>#</a></h2><p>To run our NodeJS code on the server, we need to install NodeJS runtime. I followed a tutorial from <a href=https://tecadmin.net/install-latest-nodejs-npm-on-ubuntu/>Tecadmin</a>, here are the commands to do the installation:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>sudo apt update
</span></span><span class=line><span class=cl>sudo apt install -y mongodb
</span></span><span class=line><span class=cl>sudo systemctl <span class=nb>enable</span> mongodb
</span></span><span class=line><span class=cl>sudo systemctl start mongodb
</span></span><span class=line><span class=cl>sudo systemctl status mongodb
</span></span></code></pre></div><p>The last command should give a working systemd status with a green highlight:</p><p><img loading=lazy src=/assets/mongodb-running.png alt="Running MongoDB"></p><h2 id=adding-a-new-user-account-for-deployment>Adding a new user account for deployment<a hidden class=anchor aria-hidden=true href=#adding-a-new-user-account-for-deployment>#</a></h2><p>To deploy your app, you will require a copy of your NodeJS app code on the server. It is a good practice to have a user account whose sole purpose is to serve your app.</p><p>To create a new user for your Ubuntu server, running the below command will create a new user dkapi it will also create a home directory for the user at <code>/home/dkapi</code></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>sudo useradd -m -d /home/dkapi dkapi
</span></span></code></pre></div><p>Next, you should add a password for the user that you just created, the command below will prompt for a password to be used for <code>dkapi</code>.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>sudo passwd dkapi
</span></span></code></pre></div><p>You should be able to run commands as <code>sudo</code> user with the newly created user account. The below command will allow that to be possible:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>usermod -aG sudo dkapi
</span></span></code></pre></div><p>Now, you can switch to the user you just created with:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>su - dkapi
</span></span></code></pre></div><p>Provide the password you entered when creating the account, you should find a prompt with a <code>$_</code> sign, that’s a success. Cool!</p><h2 id=creating-ssh-keys-for-github-access>Creating ssh keys for Github access<a hidden class=anchor aria-hidden=true href=#creating-ssh-keys-for-github-access>#</a></h2><p>I followed the guide by Github to create an SSH key from <a href=https://help.github.com/en/articles/generating-a-new-ssh-key-and-adding-it-to-the-ssh-agent>here</a>. Then, add the generated ssh to your Github account using the guide from <a href=https://help.github.com/en/articles/adding-a-new-ssh-key-to-your-github-account>here</a>. Finally, we can test our Github SSH set up with the guide from <a href=https://help.github.com/en/articles/testing-your-ssh-connection>here</a>.</p><h2 id=pulling-the-nodejs-codebase-from-github>Pulling the NodeJS codebase from Github<a hidden class=anchor aria-hidden=true href=#pulling-the-nodejs-codebase-from-github>#</a></h2><p>We are here, you can now pull your NodeJS code from Github. This is basically cloning the repo, and this can be done easily with:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>git clone GITHUB_SSH_URL ~/app
</span></span></code></pre></div><p>The repo will be cloned into <code>~/app</code> directory</p><p>Follow the guide <a href=https://linuxize.com/post/how-to-install-yarn-on-ubuntu-18-04/>here</a> to install Yarn on the instance, after that you can install the dependencies using yarn command.</p><h2 id=running-nodejs-app-in-the-background>Running NodeJS app in the background<a hidden class=anchor aria-hidden=true href=#running-nodejs-app-in-the-background>#</a></h2><p>For perfect integration with Nginx, you need to run your NodeJS app in the background. Packages like <a href=https://www.npmjs.com/package/forever>forever</a>, <a href=https://github.com/Unitech/pm2>pm2</a> gives this process a breeze. But, for me, I think using a <code>systemd</code> service is more appropriate, as I can start, stop and enable autostart of the service whenever the server is restarted. With the SSH access,<code>systemd</code> service has an edge over an <code>npm</code> package.</p><p>A systemd service are instruction files created at: <code>/lib/systemd/system/</code> and the files are to end with <code>.service</code> extension. Full details about <code>systemd</code> can be found <a href=https://www.freedesktop.org/software/systemd/man/systemd.service.html>here</a>. Let’s create one for ourselves.</p><p>Firstly, run <code>sudo nano /lib/systemd/system/dkapi.service</code> you can name dkapi.service<code>anything, just ensure that it ends with a</code>.service` as the file’s extension.</p><p>The content of the file should look like:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=o>[</span>Unit<span class=o>]</span>
</span></span><span class=line><span class=cl><span class=nv>Description</span><span class=o>=</span>APP API Service
</span></span><span class=line><span class=cl><span class=nv>After</span><span class=o>=</span>network.target
</span></span><span class=line><span class=cl><span class=nv>StartLimitIntervalSec</span><span class=o>=</span><span class=m>0</span>
</span></span><span class=line><span class=cl><span class=o>[</span>Service<span class=o>]</span>
</span></span><span class=line><span class=cl><span class=nv>Type</span><span class=o>=</span>simple
</span></span><span class=line><span class=cl><span class=nv>Restart</span><span class=o>=</span>always
</span></span><span class=line><span class=cl><span class=nv>RestartSec</span><span class=o>=</span><span class=m>1</span>
</span></span><span class=line><span class=cl><span class=nv>User</span><span class=o>=</span>dkapi
</span></span><span class=line><span class=cl><span class=nv>ExecStart</span><span class=o>=</span>/usr/bin/node /home/dkapi/app/start.sh
</span></span><span class=line><span class=cl><span class=nv>WorkingDirectory</span><span class=o>=</span>/home/dkapi/app   
</span></span><span class=line><span class=cl><span class=nv>StandardOutput</span><span class=o>=</span>syslog
</span></span><span class=line><span class=cl><span class=nv>StandardError</span><span class=o>=</span>syslog
</span></span><span class=line><span class=cl><span class=nv>SyslogIdentifier</span><span class=o>=</span>dk-api
</span></span><span class=line><span class=cl><span class=nv>Environment</span><span class=o>=</span> <span class=nv>NODE_ENV</span><span class=o>=</span>production
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=o>[</span>Install<span class=o>]</span>
</span></span><span class=line><span class=cl><span class=nv>WantedBy</span><span class=o>=</span>multi-user.target
</span></span></code></pre></div><p>Attention should be paid to User=dkapi that should be the user account you created for the deployment, <code>ExecStart=/home/dkapi/app/start.sh</code> this is the start command for the service, basically calling an executable <code>start.sh</code> file. The file in my own case contains:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>yarn start
</span></span></code></pre></div><p>Ensure that this file can be executed, use <code>sudo chmod +x start.sh</code> for this.</p><p>The <code>WorkingDirectory=/home/dkapi/app</code> should be the directory you pulled the files from Github into. And <code>Environment= NODE_ENV=production</code> to tell the environment variable you want the service to have.</p><p>Next, enter <code>Ctrl+X</code> then <code>ENTER</code> to save the file. Now, you have a service systemd that can be used to manage your NodeJS server instance.</p><ul><li>To enable the server to start when the server boots up we can do:</li><li>To do systemctl enable dkapi</li></ul><p>Now, we can manually start our service with:</p><p>sudo systemctl start dkapi</p><p>Greatness!!!</p><h2 id=installing-nginx-webserver>Installing Nginx webserver<a hidden class=anchor aria-hidden=true href=#installing-nginx-webserver>#</a></h2><p>NodeJS app only creates a local server, to accept request over the internet, we need a web server that will make that a breeze. We can do Apache, but I love Nginx for its simplicity, we will be installing and configuring one for this setup.</p><p>From your SSH accessed server terminal run the below command to update the installed packages:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>sudo apt update <span class=o>&amp;&amp;</span> sudo apt upgrade
</span></span></code></pre></div><p>After that, you can install Nginx with:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>sudo apt install nginx
</span></span></code></pre></div><p>A successful installation will give you:</p><p><img loading=lazy src=/assets/lightsail-nginx.png alt="Running Nginx"></p><p>Visiting the static IP attached to this instance gives the default welcome page for a successful Nginx installation. Awesomeness!!!</p><p><img loading=lazy src=/assets/lightsail-nginx-welcome.png alt="Running Nginx"></p><h3 id=nginx-configuration-for-nodejs-server-routing>Nginx configuration for NodeJs server routing<a hidden class=anchor aria-hidden=true href=#nginx-configuration-for-nodejs-server-routing>#</a></h3><p>To ensure that requests are passed to your NodeJS app, you need to have the default Nginx configuration block point to your the local URL of the app.</p><p>We will begin this by configuring our Nginx webserver.</p><p>Changing directory to <code>nginx</code> installation directory with: <code>cd /etc/nginx/</code> In the <code>sites-available</code> directory, copy the default config file to default.bak using <code>sudo cp default default.bak</code>, then use <code>sudo nano ./sites-available/default</code> to edit the content of the file.</p><p>Here is a configuration that receives a normal request from the client then transfer it to the node server we have set up above.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-nginx data-lang=nginx><span class=line><span class=cl><span class=k>server</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kn>server_name</span> <span class=s>SERVER_NAME_OR_STATIC_IP</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=kn>location</span> <span class=p>=</span> <span class=s>/favicon.ico</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kn>log_not_found</span> <span class=no>off</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kn>access_log</span> <span class=no>off</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=kn>location</span> <span class=p>=</span> <span class=s>/robots.txt</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kn>allow</span> <span class=s>all</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kn>log_not_found</span> <span class=no>off</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kn>access_log</span> <span class=no>off</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=kn>location</span> <span class=s>/</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kn>proxy_pass</span> <span class=s>http://localhost:3000</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kn>proxy_http_version</span> <span class=mi>1</span><span class=s>.1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kn>proxy_set_header</span> <span class=s>Upgrade</span> <span class=nv>$http_upgrade</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kn>proxy_set_header</span> <span class=s>Connection</span> <span class=s>&#39;upgrade&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kn>proxy_set_header</span> <span class=s>Host</span> <span class=nv>$host</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kn>proxy_set_header</span> <span class=s>X-Real-IP</span> <span class=nv>$remote_addr</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kn>proxy_cache_bypass</span> <span class=nv>$http_upgrade</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=kn>access_log</span> <span class=s>/var/log/nginx/dkapi-access.log</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=kn>error_log</span> <span class=s>/var/log/nginx/dkapi-error.log</span> <span class=s>error</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>Change the <code>SERVER_NAME_OR_STATIC_IP</code> to your server name that points to the static IP, or just use the Lightsail server static IP.</p><p>If all went well, visiting the server name or static IP should yield the default response for our app. Mine:</p><p><img loading=lazy src=/assets/lightsail-web.png alt="Running Nginx"></p><h3 id=adding-free-ssl-by-letsencrypt>Adding free SSL by letsencrypt<a hidden class=anchor aria-hidden=true href=#adding-free-ssl-by-letsencrypt>#</a></h3><p>Sometimes, accessing our NodeJS app using normal unsecured HTTP would throw a warning screen or will not resolve. This is a security feature implemented by web browsers and hosting providers. To this, I always install SSL for <code>nginx</code> servers. We will be doing a setup with let’s encrypt as generally done.</p><p>Run the below command to install <code>certbot</code> package.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>apt-get install software-properties-common
</span></span><span class=line><span class=cl>add-apt-repository ppa:certbot/certbot
</span></span><span class=line><span class=cl>apt-get update
</span></span><span class=line><span class=cl>apt-get install python-certbot-nginx
</span></span></code></pre></div><p>To set up an SSL for your domain, you can do:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>certbot --nginx
</span></span></code></pre></div><p>It will check the CN (common name) in the existing Nginx configuration file, if not found then it will prompt you to enter the domain name.</p><p>Certbot automation is <em>smart!</em> It will take care of all the necessary configurations to make your Nginx ready to serve over https.</p><p>Not so fast, but we now have SSL support for our <code>nginx</code> web server at the specified domain name.</p><p>To allow HTTPS requests to come through into the VPS instance, you have to modify the firewall from the Network tab on the instance dashboard. Click on <em>Add another</em>, select HTTPS, then click on the green tick.</p><p>It should look something like this:</p><p><img loading=lazy src=/assets/lightsail-firewall.png alt="Running Firewall"></p><p>And that’s it! Full HTTPS support without an extra.</p><h2 id=taking-things-further>Taking things further<a hidden class=anchor aria-hidden=true href=#taking-things-further>#</a></h2><p>If you have a build process and a Continous Integration, you should be thinking of setting it up. This would protect against the round trip of pulling and restarting our app on the server.</p><p>I assume that the project has been set up on CircleCI already using a Github account. Let’s move forward.</p><p>f you notice from the bottom page of the Lightsail server instance dashboard Connect tab, it states, “You configured this instance to use id_rsa (key_region) key pair.” This is a secret SSH key and can be managed from <a href=https://lightsail.aws.amazon.com/ls/webapp/account/keys>https://lightsail.aws.amazon.com/ls/webapp/account/keys</a>.</p><p>The keys from the page above are private keys whose public keys are included in instance setups. Lucky enough, it has been included in my own setup and it is what <code>CircleCI</code> is requesting to access my server remotely. It is not included in the authorised_keys of the user account that you have created, you are to add the public key in there.</p><p>To get the content of the file, firstly download the ssh key attached to the instance, next use <code>cat</code> command to show the content of the file. In my own case:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>cat LightsailDefaultKey-us-east-1.pem
</span></span></code></pre></div><p>On the project page in <code>CircleCI</code> dashboard, click the settings icon close to the project, then SSH Permissions. Click on the blue Add SSH Key button enter the domain name for the key, then paste the copy private key into the Private key input, click the light blue Add SSH Key button to complete the process.</p><p>New user accounts do not come with the private ssh configured, we have to manually add this ourselves. To do this, we can generate a public key from the downloaded private key using:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>ssh-keygen -y -f ~/.ssh/lightsail.pem &gt; ~/.ssh/lightsail.pem.pub
</span></span></code></pre></div><p>Then you can copy the content of <code>~/.ssh/lightsail.pem.pub</code> to the <code>authorized_keys</code> file of the account for your app. Simply:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>su — dkapi
</span></span><span class=line><span class=cl>sudo nano ~/.ssh/authorized_keys
</span></span></code></pre></div><p>Paste the copied public key into the file, then <code>Ctrl + X</code> to save.</p><p>Below is the CircleCI config for my own project, yours might be different. The important part here is the command section.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yml data-lang=yml><span class=line><span class=cl><span class=nt>version</span><span class=p>:</span><span class=w> </span><span class=m>2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>jobs</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>staging</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>docker</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>circleci/node:10</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>steps</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>run</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>Deploy API</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>command</span><span class=p>:</span><span class=w> </span><span class=l>ssh -o &#34;StrictHostKeyChecking no&#34; api@staging.datingkinky.com &#34;cd ~/app; git pull; yarn install --production; sudo systemctl restart dkapi&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>workflows</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>version</span><span class=p>:</span><span class=w> </span><span class=m>2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>staging</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>jobs</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>staging</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>filters</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>branches</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=nt>only</span><span class=p>:</span><span class=w> </span><span class=l>develop</span><span class=w>
</span></span></span></code></pre></div><p>The emphasis is on this:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>ssh -o <span class=s2>&#34;StrictHostKeyChecking no&#34;</span> dkapi@staging.datingkinky.com <span class=s2>&#34;cd ~/app; git pull; yarn install --production; sudo systemctl restart dkapi&#34;</span>
</span></span></code></pre></div><p>To note from the above command:</p><ul><li><code>dkapi@staging.datingkinky.com</code>: We want to connect to the instance but as the <code>dkapi</code> user we created.</li><li><code>cd ~/app</code>: Change directory to the app directory we pulled the code into.</li><li><code>git pull</code>: Pull the code from Github to keep the code updated</li><li><code>yarn install  — production</code>: Install dependencies that might have just been included.</li><li><code>sudo systemctl restart dkapi</code>: Restarts the <code>dkapi</code> service running the NodeJS app in the background using <code>systemd</code> service</li></ul><p>A perfect process right?</p><p>Push a new code, let CircleCI do your deployment and restarting the node app for you. Sooo cool!!!</p><p>Beautiful? Not yet!</p><h2 id=gotcha>Gotcha<a hidden class=anchor aria-hidden=true href=#gotcha>#</a></h2><p>I ran into a failing build, which is a result of the <code>systemctl</code> command. The error states</p><pre tabindex=0><code>no tty present and no askpass program specified
</code></pre><p>Basically, we have to bypass <code>systemctl</code> asking for password whenever we run it from a trusted machine. I found the solution from <a href=https://stackoverflow.com/questions/21659637/how-to-fix-sudo-no-tty-present-and-no-askpass-program-specified-error#answer-24107529>Stackoverflow</a>.</p><p>Now, we have to ssh as a root user, then run:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>sudo visudo
</span></span></code></pre></div><p>The command will pop a file for editing, it is a delicate file that can mar all the effort we have put into the setup. What we have to do in here is to go to the end of the file to add:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>dkapi <span class=nv>ALL</span> <span class=o>=</span> NOPASSWD: /bin/systemctl
</span></span></code></pre></div><p>Replace <code>dkapi</code> with the user you created in for deployment.</p><p>Use <code>Ctrl+X</code> to exit the file. Then, we can rerun the failed <code>CircleCI</code> workflow or push a new code to test the setup.</p><p>It ran successfully in my own case, I believe yours too would have been successful.</p><h4 id=awesome>Awesome!!!<a hidden class=anchor aria-hidden=true href=#awesome>#</a></h4><h2 id=highlights>Highlights<a hidden class=anchor aria-hidden=true href=#highlights>#</a></h2><ul><li>Spinup a Lightsail instance</li><li>Add a static IP to the instance</li><li>Allow SSH access from a local machine</li><li>Installing NodeJS</li><li>Installing MongoDB</li><li>Adding a new user account for deployment</li><li>Creating ssh key for Github access</li><li>Pulling the NodeJS repo from Github</li><li>Running NodeJS app in the background</li><li>Installing Nginx webserver</li><li>Nginx configuration for NodeJS server routing</li><li>Adding free SSL by letsencrypt</li><li>Integrate CircleCI</li><li>CircleCI integration gotcha</li></ul><h2 id=conclusion>Conclusion<a hidden class=anchor aria-hidden=true href=#conclusion>#</a></h2><p>Following through this post, we have configured a non-existent AWS Lightsail server instance to run a NodeJS app. We have been able to set up the code to run a <code>systemd</code> service for the app to be able to run in the background.</p><p>We added SSL and then finalized the setup with a CircleCI integration and a fix to a known error that could cause the build process to fail.</p><p>I will like to learn if there is any part that could be improved, know about a bug that stops your own setup and learn more about the AWS Lightsail Servers.</p><p>Thank you for reading. I appreciate your patience!!!</p></div><footer class=post-footer><ul class=post-tags><li><a href=https://limistah.dev/tags/aws/>AWS</a></li><li><a href=https://limistah.dev/tags/mongodb/>MongoDB</a></li><li><a href=https://limistah.dev/tags/nodejs/>NodeJS</a></li><li><a href=https://limistah.dev/tags/nginx/>Nginx</a></li></ul><nav class=paginav><a class=prev href=https://limistah.dev/posts/programmer-sexiness-quest/><span class=title>« Prev</span><br><span>Programmer's Sexiness Quest</span>
</a><a class=next href=https://limistah.dev/posts/clean-code-series/><span class=title>Next »</span><br><span>Clean Code – Rules For Name Crafting (Series)</span></a></nav><ul class=share-buttons><li><a target=_blank rel="noopener noreferrer" aria-label="share Complete NodeJS App Setup  on an AWS Lightsail VPS on x" href="https://x.com/intent/tweet/?text=Complete%20NodeJS%20App%20Setup%20%20on%20an%20AWS%20Lightsail%20VPS&amp;url=https%3a%2f%2flimistah.dev%2fposts%2fnodejs-lightsail-setup%2f&amp;hashtags=AWS%2cMongoDB%2cNodeJS%2cNginx"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M512 62.554V449.446C512 483.97 483.97 512 449.446 512H62.554C28.03 512 0 483.97.0 449.446V62.554C0 28.03 28.029.0 62.554.0H449.446C483.971.0 512 28.03 512 62.554zM269.951 190.75 182.567 75.216H56L207.216 272.95 63.9 436.783h61.366L235.9 310.383l96.667 126.4H456L298.367 228.367l134-153.151H371.033zM127.633 110h36.468l219.38 290.065H349.5z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Complete NodeJS App Setup  on an AWS Lightsail VPS on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https%3a%2f%2flimistah.dev%2fposts%2fnodejs-lightsail-setup%2f&amp;title=Complete%20NodeJS%20App%20Setup%20%20on%20an%20AWS%20Lightsail%20VPS&amp;summary=Complete%20NodeJS%20App%20Setup%20%20on%20an%20AWS%20Lightsail%20VPS&amp;source=https%3a%2f%2flimistah.dev%2fposts%2fnodejs-lightsail-setup%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Complete NodeJS App Setup  on an AWS Lightsail VPS on reddit" href="https://reddit.com/submit?url=https%3a%2f%2flimistah.dev%2fposts%2fnodejs-lightsail-setup%2f&title=Complete%20NodeJS%20App%20Setup%20%20on%20an%20AWS%20Lightsail%20VPS"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Complete NodeJS App Setup  on an AWS Lightsail VPS on facebook" href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2flimistah.dev%2fposts%2fnodejs-lightsail-setup%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Complete NodeJS App Setup  on an AWS Lightsail VPS on whatsapp" href="https://api.whatsapp.com/send?text=Complete%20NodeJS%20App%20Setup%20%20on%20an%20AWS%20Lightsail%20VPS%20-%20https%3a%2f%2flimistah.dev%2fposts%2fnodejs-lightsail-setup%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23C231.8 264.15 222.81 249.484 220.198 245s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Complete NodeJS App Setup  on an AWS Lightsail VPS on telegram" href="https://telegram.me/share/url?text=Complete%20NodeJS%20App%20Setup%20%20on%20an%20AWS%20Lightsail%20VPS&amp;url=https%3a%2f%2flimistah.dev%2fposts%2fnodejs-lightsail-setup%2f"><svg viewBox="2 2 28 28" height="30" width="30" fill="currentcolor"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47 3.38 3.38.0 01-2.51 1.02zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Complete NodeJS App Setup  on an AWS Lightsail VPS on ycombinator" href="https://news.ycombinator.com/submitlink?t=Complete%20NodeJS%20App%20Setup%20%20on%20an%20AWS%20Lightsail%20VPS&u=https%3a%2f%2flimistah.dev%2fposts%2fnodejs-lightsail-setup%2f"><svg width="30" height="30" viewBox="0 0 512 512" fill="currentcolor" xmlns:inkscape="http://www.inkscape.org/namespaces/inkscape"><path d="M449.446.0C483.971.0 512 28.03 512 62.554V449.446C512 483.97 483.97 512 449.446 512H62.554C28.03 512 0 483.97.0 449.446V62.554C0 28.03 28.029.0 62.554.0H449.446zM183.8767 87.9921h-62.034L230.6673 292.4508V424.0079h50.6655V292.4508L390.1575 87.9921H328.1233L256 238.2489z"/></svg></a></li></ul></footer></article></main><footer class=footer><span>&copy; 2024 <a href=https://limistah.dev>limistah</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>